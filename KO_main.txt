//===== rAthena Script ======================================
//= Kagerou/Oboro Job Change Quest
//===== By: ================================================== 
//= M45T3R, Dastgir Pojee
//===== Current Version: ===================================== 
//= 1.2
//===== Description: ========================================= 
//= Kagerou/Oboro Job Change NPC
//===== Additional Comments: ================================= 
//= 1.0 Extracted from iRO(Official?) [M45T3R]/[Dastgir Pojee]
//= 1.1 Added Ninja Check,Rearranged the Scripts. [Dastgir Pojee]
//= 1.2 Fixed Many Errors.	[Dastgir Pojee]
//============================================================

que_ng,28,156,1	script	Start#ko	-1,1,1,{
OnTouch:
if ((BaseJob==25) && (BaseLevel == 99) && (JobLevel == 70) && (checkquest(5131) == -1)){
	mes "Secret Passage to ^25C18DNinja Guild^25C18D";
	mes "You hear familiar voices talking to each other.";
	next;
	mes "[Unknown Voice A]";
	mes "Long time, no see. How are you? How are the kids you've taken in?";
	next;
	mes "[Unknown Voice B]";
	mes "I have to hand it to you. You've picked some competitive ones.";
	next;
	mes "[Unknown Voice A]";
	mes "Sounds like music to my ears. Being sent to a foreign land with air pollution was bad enough, now haunted with memories of this place...";
	next;
	mes "[Unknown Voice A]";
	mes "What do you think? Should we rotate now?";
	next;
	mes "[Unknown Voice B]";
	mes "Haven't given up, have ya. Do you really think he'll approve?";
	next;
	mes "[Unknown Voice A]";
	mes "No need to be bitter. Hey! Were any of the kids that come and go here the ones that found the ^BD0408place^BD0408?";
	next;
	mes "[Unknown Voice B]";
	mes "Since finding the hidden place was also a part of the test.";
	next;
	mes "[Unknown Voice A]";
	mes "You are as stubborn as the first time I met you. It's just a wall in some place...";
	next;
	mes "[Unknown Voice B]";
	mes "Shssh! I think someone is eavesdropping. Hurry! Go back to the mission area.";
	next;
	mes "The conversation stopped abruptly. Hidden place? Wall? Part of a test? What is all this about?";
	setquest 5131;	//Strange Conversation
	close;
}
end;
}

que_ng,10,183,1	warp	warp#ko	1,1,que_ng,33,64	//Warp in que_ng

que_ng,21,76,1	script	Wall with a Drawing#ko	909,{
if (checkquest(5132) == 2){
	mes "Entrance to the ^25C18DNinja Guild^25C18D hideout.";
	next;
	if(select("Enter.:Do not enter.") == 1){
			warp "job_ko",26,111;
		}
	close;
}
else if (checkquest(5131) == 1 && Class == 25 && BaseLevel >= 99 && JobLevel >= 70){
	mes "You found a location that resembles the hidden place.";
	next;
	mes "This wall was here ever since. How come I didn't notice it before?";
	next;
	mes "Now that I know it's a secret passage, what do I do to get in?";
	next;
	switch(select("Tear the drawing down.:Touch the drawing with your hand.")){
		case 1:
			mes "I can't rip it down because I don't own it.";
			break;
		case 2:
			mes "You touch the drawing with the tip of your hand and felt a sudden sensation of being pulled.";
			close2;
			warp "job_ko",26,111;
	}
}
else{
	mes "There is a wall with a great drawing on it.";
	close;
}
}

job_ko,25,115,1	script	Old Man#ko	909,{
if (checkquest(5138) == 1 && checkquest(5135) == 1) callfunc "KO_IB",2; else if (checkquest(5137) == 1 && checkquest(5135) == 1 ) callfunc "KO_IB",1;
else if (checkquest(5131)==1){
	mes "^1A95E6An old man looking hale and hearty is sitting and gazing vacantly.^1A95E6";
	next;
	switch(select("Ignore.:Talk to him.")){
		case 1: close;
		case 2:
			mes "["+strcharinfo(0)+"]";
			mes "Excuse me...";
			next;
			mes "^1A95E6You tried to talk to the old man but there is no response. Just when you are about to turn away...^1A95E6";
			next;
			mes "[Old Man]";
			mes "At last, a customer! Hmm... and a live one, too!";
			if (select("Excuse me... where am I?")==1){
				mes "^1A95E6He keeps talking and doesn't stop to answer your question.^1A95E6";
				next;
				mes "[Old Man]";
				mes "There once was a quiet family living in ancient Amatsu times that is never mentioned in history books or stories.";
				next;
				mes "[Old Man]";
				mes "They lived beneath shadows but always yearned for the bright sun, like a sunflower.";
				next;
				mes "[Old Man]";
				mes "A family that was loyal to their lord who they served as their bright sun.";
				next;
				mes "[Old Man]";
				mes "...a very trustworthy family...";
				next;
				mes "[Old Man]";
				mes "....loyal to their core...";
				next;
				mes "[Old Man]";
				mes "...a family of integrity...";
				next;
				if (select("What happened to them?")==1){
					mes "^1A95E6The old man looks at you with a melancholy face.^1A95E6";
					next;
					mes "[Old Man]";
					mes "Why are you interested in a family that was abandoned by their lord and disappeared from history itself?";
					next;
					switch(select("I'm a Ninja.:I'm bored.")){
						case 1:
							mes "[Old Man]";
							mes "Ninja! There was a time when the family was called ninjas, too.";
							next;
							changequest 5131,5132;
							mes "[Old Man]";
							mes "You'll have to lend me your ear for I have so much to tell you about the family story.";
							close;
						case 2:
							mes "[Old Man]";
							mes "Was nice to meet you.";
							sleep2 2000;
							warp "amatsu",147,136;
							end;
					}
				}
			}
	}
} else if (checkquest(5132) == 1){
	mes "^1A95E6The Old Man starts the story with a very soothing tone as if he is telling his grandchild a story.^1A95E6";
	next;
	mes "[Old Man]";
	mes "This goes way back to ancient times and nobody in Amatsu remembers about it.";
	next;
	mes "[Old Man]";
	mes "The family worked behind the scenes and basically lived their lives for their lord.";
	next;
	mes "[Old Man]";
	mes "They were very loyal doing whatever deed their lord asked for.";
	next;
	mes "[Old Man]";
	mes "Ninja, the family was known as the dark family but that doesn't mean they wanted to be hidden in the darkness.";
	next;
	mes "[Old Man]";
	mes "They were loyal enough to be satisfied as the lord's servants but their loyalty became the problem.";
	next;
	if (select("Problem?")==1){
		mes "[Old Man]";
		mes "They are a secret organization that even the lord didn't know much about.";
		next;
		mes "[Old Man]";
		mes "The few that knew about the family's existence, tried to investigate them but nobody was able to reveal their true identity.";
		next;
		mes "[Old Man]";
		mes "That is why this family has grown from loyal servants to a group feared for its secrets.";
		next;
		mes "[Old Man]";
		mes "The lord shunned the family and didn't call them for their service any more but they never betrayed him.";
		next;
	}
	if (select("They were really loyal people.")==1){
		mes "[Old Man]";
		mes "Yes, they were. Very loyal.";
		next;
		changequest 5132,5133;
		mes "^1A95E6The old man looks even more forlorn.^1A95E6";
		close;
	}
} else if (checkquest(5133) == 1){
	mes "[Old Man]";
	mes "The family has been living in hiding for so long since the old days. The current lord didn't even know of their existence.";
	next;
	if (select(".........")==1){
			mes "[Old Man]";
			mes "I'm Guide Gion, the last of the dark ninja family.";
			next;
			switch(select("I think your time has ended.:I need your teaching.")){
				case 1:
					mes "[Guide Gion]";
					mes "Are you an assassin to end this old man's life?";
					next;
					mes "[Guide Gion]";
					mes "So that is why you've shown interest in my family. I won't give up easily.";
					next;
					mes "Pow!!";
					mes "You lose conscience with the great impact.";
					sleep2 2000;
					warp "amatsu",147,136;
					end;
				case 2:
					mes "[Guide Gion]";
					mes "Teaching...";
					mes "Been a long time since I last heard that word.";
					next;
					mes "[Guide Gion]";
					mes "I guess this little visit was not by coincidence but a start of a connection.";
					next;
					mes "[Guide Gion]";
					mes "Sorry I am not a teacher. But!";
					next;
					mes "[Guide Gion]";
					mes "I can help you on the path you've chosen, the ^33CC71"+((Sex)?"Kagerou":"Oboro")+"^33CC71 path.";
					next;
					mes "^1A95E6You hear Guide Gion's voice faintly as you slip away.^1A95E6";
					next;
					changequest 5133,5134;	//New path
					mes "[Guide Gion]";
					mes "If you are prepared to follow me, Guide Gion, on the Oboro path, we will meet again.";
					warp "amatsu",147,136;
					end;
			}
	}
}else if (checkquest(5134) == 1){
	mes "[Guide Gion]";
	mes "I thought you were afraid of the ^33CC71path of the "+((Sex)?"Kagerou":"Oboro")+"^33CC71 and wouldn't come back.";
	next;
	mes "[Guide Gion]";
	mes "But from the look of your eyes, I guess I misjudged you.";
	next;
	mes "[Guide Gion]";
	mes "You will have to train your mind and body to walk steadily in the unknown world and never fall into temptation to stay on the path.";
	next;
	mes "[Guide Gion]";
	mes "Our ancestors had 4 tests to train our people.";
	next;
	if (select("4 tests?")==1){	
		mes "[Guide Gion]";
		mes "Yes, there are 4 tests.";
		mes "My ancestors trained my people with 4 tests that involve ^087FF8knowledge^087FF8, ^087FF8survival^087FF8, ^087FF8weapons^087FF8, and ^087FF8battle^087FF8.";
		next;
		mes "[Guide Gion]";
		mes "I know you are curious what these tests are. Let me explain one by one.";
		while (1) {
			if (KO_Q&1 && KO_Q&2 && KO_Q&4 && KO_Q&8){
				changequest 5134,5135;	//4 tests
				mes "[Guide Gion]";
				mes "Let's start right away after you are done with preparations.";
				close;
			}
			next;
			switch(select("Test of Knowledge:Test of Survival:Test of Weaponry:Test of Battle")){
				case 1:
					mes "[Guide Gion]";
					mes "We need to be knowledgeable in order to assist the lord. This test is for this purpose.";
					next;
					mes "[Guide Gion]";
					mes "You can pass the test if you successfully solve more than 9 out of 10 questions.";
					next;
					mes "[Guide Gion]";
					mes "The test will be easy to pass if you've been steady in your studies. Now what other test are you curious about?";
					set KO_Q,KO_Q|1;
					break;

				case 2:
					mes "[Guide Gion]";
					mes "Missions aren't always easy and safe. That is why survival instincts are vital to us.";
					next;
					mes "[Guide Gion]";
					mes "My ancestors call this test the dice test. It is a test to advance forward depending on the dice results.";
					next;
					mes "[Guide Gion]";
					mes "Think of it as the simple dice games people play.";
					next;
					mes "[Guide Gion]";
					mes "But never let your guard down during the test because it isn't called the survival test for nothing.";
					next;
					mes "[Guide Gion]";
					mes "There will be blocks that help you while there are blocks that will interrupt you.";
					next;
					mes "[Guide Gion]";
					mes "If you deal with various situations wisely, you will be able to pass the test. Now what other test are you curious about?";
					set KO_Q,KO_Q|2;
					break;

				case 3:
					mes "[Guide Gion]";
					mes "My family was famous for using unique weapons that we created.";
					next;
					mes "[Guide Gion]";
					mes "You would be considered blessed if you created your own unique weapon.";
					next;
					mes "[Guide Gion]";
					mes "Creating a weapon for yourself and refining it is the purpose of this test.";
					next;
					mes "[Guide Gion]";
					mes "I hope you will be blessed and find the best weapon for yourself. Now what other test are you curious about?";
					set KO_Q,KO_Q|4;
					break;

				case 4:
					mes "[Guide Gion]";
					mes "Missions are not always done alone. You will often work in teams of 2 or 3 for a common goal.";
					next;
					mes "[Guide Gion]";
					mes "The battle test is only for those that pass that knowledge, survival and weapon tests. So! It is the very last test.";
					next;
					mes "[Guide Gion]";
					mes "Unlike the other three tests that are done alone, you will have to compete with others in this final test.";
					next;
					mes "[Guide Gion]";
					mes "There is only one target!!";
					mes "And only the first to get to the target passes the test.";
					next;
					mes "[Guide Gion]";
					mes "You'll be lucky if you have no competitors during your test.";
					next;
					mes "[Guide Gion]";
					mes "A challenge is better than explaining it a hundred times. It's the actual experience that makes you better.";
					set KO_Q,KO_Q|8;
					break;
			}
		}
	}
} else if (checkquest(5135) == 1){
	mes "[Guide Gion]";
	mes "It's been a while.";
	next;
	mes "[Guide Gion]";
	mes "Since I felt happy like this. I feel young and energetic seeing young people like you challenge themselves with a new path.";
	next;
	mes "[Guide Gion]";
	mes "We're done with explaining about the tests, now should I tell you my family story?";
	next;
	mes "[Guide Gion]";
	mes "My family started from two warriors.";
	next;
	mes "[Guide Gion]";
	mes "Kagerou a warrior like the dancing flames of the sun.";
	next;
	mes "[Guide Gion]";
	mes "Oboro a warrior like the misty moonlight.";
	next;
	mes "[Guide Gion]";
	mes "The Sun and the Moon.";
	mes "The sunlight that lights up the world and the moonlight that lights up the night. Both were very similar but different warriors.";
	next;
	mes "[Guide Gion]";
	mes "There was a time there was an enmity between both warriors.";
	next;
	mes "[Guide Gion]";
	mes "But it didn't take long for them to become one as a family.";
	next;
	if (select("How did it go afterwards?")==1){
		mes "[Guide Gion]";
		mes "Ha ha ha. It is never fun to listen to the whole story all at once, no? Come back after passing a test and I'll continue my story.";
		next;
		mes "[Guide Gion]";
		mes "Which test will you select as your first test?";
		next;
		switch(select("Test of Knowledge:Test of Survival:Test of Weaponry")){
			case 1:
				mes "[Guide Gion]";
				mes "You are starting with the ^339CCCTest of Knowledge^339CCC? Then I will get to see a familiar face after so long.";
				next;
				if(select("Familiar face?")==1){
					setquest 5136;
					mes "[Guide Gion]";
					mes "Ha ha ha. You'll know when we get there. The Test of Knowledge is taken over here.";
					sleep2 2000;
					warp "job_ko",72,128;
					end;
				}
			case 2:
				mes "[Guide Gion]";
				mes "You are starting with the ^339CCCTest of Survival^339CCC? It's a lonesome test that you have to face alone.";
				mes "But I believe you can handle it. The Test of Survival is taken over here.";
				setquest 5137;
				sleep2 2000;
				warp "job_ko",62,16;
				end;
			case 3:
				mes "You are starting with the ^339CCCTest of Weaponry^339CCC? I have something to give you before you go.";
				next;
				setquest 5138;	//Weapons test
				getitem 1002,5; getitem 1010,1;
				mes "You receive 5 Iron Ore and 1 Phracon.";
				mes "You will find these useful. The Test of Weaponry is taken over here.";
				sleep2 2000;
				warp "job_ko",121,129;
				end;
		}
	}
} 

if (checkquest(5136)==2 || KO_Q){
mes "[Guide Gion]";
mes "You've passed the Test of "+((KO_Q))?"Knowledge":"Survival":"Weaponry")+".";
next;
}
mes "[Guide Gion]";
mes "My friend doesn't approve of others that easily but I guess he liked you.";
next;
if (select("Please continue with the family story.")==1){
	mes "[Guide Gion]";
	mes "Looks like you are pretty eager to hear more. Where did I leave off... Ah! I remember.";
	next;
	mes "[Guide Gion]";
	mes "Kagerou, warrior like the dancing flames of the sun";
	next;
	mes "[Guide Gion]";
	mes "Oboro, warrior like the misty moonlight";
	next;
	mes "[Guide Gion]";
	mes "Both warriors weren't close at first, because personality and everything else was completely opposite of each other.";
	next;
	mes "[Guide Gion]";
	mes "The first place they met was the battlefield. And you know how enemies greet each other on a battlefield.";
	next;
	mes "[Guide Gion]";
	mes "They ended up injuring each other badly.";
	next;
	mes "[Guide Gion]";
	mes "But what can you do? War is a war.";
	next;
	mes "[Guide Gion]";
	mes "The friend you've laughed with yesterday is a foe that you have to fight with in a war today.";
	next;
	mes "[Guide Gion]";
	mes "So nobody can get along with anyone during a war.";
	next;
	mes "[Guide Gion]";
	mes "I'll continue the story after you pass another test.";
	next;
	mes "[Guide Gion]";
	mes "Which test will you choose for the second test?";
	next;
	switch(select("Test of Survival:Test of Weaponry")){
		case 1:
			mes "[Guide Gion]";
			mes "You've chosen the Test of Survival as your second test? It's a lonesome test that you have to face alone.";
			next;
			setquest 5137;
			mes "[Guide Gion]";
			mes "But I believe you can handle it. The Test of Survival is taken over here.";
			warp "job_ko",62,16;
			end;
		case 2:
			mes "You are starting with the ^339CCCTest of Weaponry^339CCC? I have something to give you before you go.";
			next;
			setquest 5138;	//Weapons test
			getitem 1002,5; getitem 1010,1;
			mes "You receive 5 Iron Ore and 1 Phracon.";
			mes "You will find these useful. The Test of Weaponry is taken over here.";
			sleep2 2000;
			warp "job_ko",121,129;
			end;
	}
}

function	KO_IB	{	//Kagerou/Oboro In-Between
	//0=Test of Knowledge:1=Test of Survival:2=Test of Weaponry:3=Test of Battle
	mes "[Guide Gion]";
	mes "I see you are in the middle of the ^339CCCTest of "+((getarg(0)==0)?"Knowledge":((getarg(0)==1)?"Survival":((getarg(0)==2)?"Weaponry":"Battle")))+"^339CCC. Will you go back to the test site?";
	switch(select("Go back to the test site.:Visit the village.")){
		case 1:
		mes "Test of "+((getarg(0)==0)?"Knowledge":((getarg(0)==1)?"Survival":((getarg(0)==2)?"Weaponry":"Battle")))+" The test site is over here.";
		sleep2 2000;
		if (getarg(0)==0){warp "job_ko",72,128;}
		if (getarg(0)==1){warp "job_ko",62,16;}
		if (getarg(0)==2){warp "job_ko",121,129;}
		if (getarg(0)==3){warp "job_ko",72,128;} // Needs Info
		end;
	case 2:
		mes "[Guide Gion]";
		mes "The village is over here.";
		warp "amatsu",147,136;
		end;
	}
}
}